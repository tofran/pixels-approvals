<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Pixels Approvals</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="Chart.bundle.min.js"></script>
	<style>
		body{
			font-family: sans-serif;
		}
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }

		#approvedList{
			list-style-type: none;
			/*max-height: 1000px;*/
		}

		#approvedList li{
			padding-bottom: 4px;
		}

		#approvedList li a{
			text-decoration: none;
		}

		#approvedList li img{
			width: 50px;
			vertical-align: top;
			margin-right: 4px;
		}

		#approvedList li span{
			color: #515151;
			font-size: 0.8em;
			margin-left: 4px;
		}
	</style>

	<script>
		(function(){
			var timeline = {}, badgesData = null, showImages = false;

			$(function() {
				$.ajax({
					url: 'https:/api.pixels.camp/badges/owners/92',
					dataType: 'json',
					success: function( data ) {
						badgesData = data.owners['2017'];
						timeline = toTimeline(badgesData);
						drawGraph(timeline);
						outputList(badgesData);
					},
					error: function( data ) {
				 		alrt("Error retrieving data from tehe API.");
					}
				 });
				 $("#showImagesCheck").click(function(){
					 showImages = !showImages;
					 outputList(badgesData);
				 });
			});

			function outputList(data = badgesData, date = null, query = null){
				console.log(data.length);
				approvedList = $('#approvedList');
				approvedList.empty();
				data.forEach(function(each){
					approvedList.append(
						"<li><a href='https://pixels.camp/" + each.user + "'>" + (showImages ? "<img src='" + each.avatar_url + "'/>" : "") + each.user + "</a><span>" + each.created + "</span></li>"
					);
				});
			}

			function toTimeline(badges) {
				var tml = {};
				for(var each of badges){
					var day = each.created.substring(0, 10).replace('-', '');
					if(!(day in tml)){
						tml[day] = [];
					}
					tml[day].push(each.user);
				}
				return tml;
			}

			function drawGraph(timelineData, cumulative = true, scaleMax = undefined){
				var values = [], cum = 0;

				for(var element of Object.values(timelineData)){
					if (!cumulative) {
						cum = 0;
					}
					cum += element.length
					values.push(cum);
				}

				var color = Chart.helpers.color;
				var color_blue = 'rgb(54, 162, 235)';
				var config = {
					type: 'line',
					data: {
						labels: Object.keys(timelineData),
						datasets: [{
							label: "Approvals",
							backgroundColor: color(color_blue).alpha(0.5).rgbString(),
							borderColor: color_blue,
							fill: true,
							data: values,
							cubicInterpolationMode: 'monotone'
						}]
					},
					options: {
				    title:{
				        text: "Pixel Approvals"
				    },
						legend: {
				        display: false
				    },
						scales: {
							xAxes: [{
								type: "time",
								time: {
									format: 'YYYYMMDD',
									tooltipFormat: 'MMM DD',
									unit: 'day',
									unitStepSize: 1,
									displayFormats: {
					           millisecond: 'MMM DD',
					           second: 'MMM DD',
					           minute: 'MMM DD',
					           hour: 'MMM DD',
					           day: 'MMM DD',
					           week: 'MMM DD',
					           month: 'MMM DD',
					           quarter: 'MMM DD',
					           year: 'MMM DD',
									}
								},
								scaleLabel: {
									display: true,
									labelString: 'Date'
								},
							}],
							yAxes: [{
								scaleLabel: {
									display: true,
									labelString: 'Approvals',
								},
								ticks: {
									max: scaleMax,
	                min: 0
		            }
							}]
						},
					}
				};

				var ctx = $("#canvas")[0].getContext("2d");
				window.chart = new Chart(ctx, config);
			}
		})();
	</script>

</head>

<body>
	<main>
		<h1>Pixel Camp Approvals</h1>
		<div style="width:75%;">
			<canvas id="canvas"></canvas>
		</div>

		<h2>Approved users</h2>
		<label>Show avatars: <input type="checkbox" id="showImagesCheck"/></label>
		<label>Search: <input type="text" placeholder="username" id="searchBox"/></label>
		<ul id="approvedList">
		</ul>

	</main>
	<footer>
		by tofran, source on <a href="https://github.com/tofran/pixels-approvals">github</a>.
	</footer>
</body>
</html>
